CREATE TABLE users (
    user_id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(512) NOT NULL,
    first VARCHAR(255),
    last VARCHAR(255),
    address VARCHAR(255),
    tell_nr VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE doctors (
    doctor_id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(512) NOT NULL,
    first VARCHAR(255),
    last VARCHAR(255),
    registration_nr VARCHAR(255),
    practice_nr VARCHAR(255),
    tell_nr VARCHAR(20),
    doctor_type ENUM('Specialist', 'Anaesthetist', 'Surgeon') DEFAULT 'Anaesthetist',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE features (
    feature_id INT AUTO_INCREMENT PRIMARY KEY,
    feature_name VARCHAR(255)
);

CREATE TABLE user_features (
    user_feature_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT,
    feature_id INT,
    is_active BOOLEAN DEFAULT FALSE,
    permissions ENUM('View', 'Edit', 'Delete') DEFAULT 'View',
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (feature_id) REFERENCES features(feature_id) ON DELETE SET NULL
);

CREATE TABLE logs (
    log_id INT AUTO_INCREMENT PRIMARY KEY, 
    user_id INT, 
    action VARCHAR(255), 
    old_value JSON, -- Allow storing structured data for old values
    new_value JSON, -- Allow storing structured data for new values
    target_table VARCHAR(255), -- Name of the affected table
    target_id INT, -- ID of the affected row in the target table
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE SET NULL
);

CREATE TABLE doctors_logs (
    log_id INT AUTO_INCREMENT PRIMARY KEY, 
    doctor_id INT, 
    action VARCHAR(255), 
    old_value JSON, -- Allow storing structured data for old values
    new_value JSON, -- Allow storing structured data for new values
    target_table VARCHAR(255), -- Name of the affected table
    target_id INT, -- ID of the affected row in the target table
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (doctor_id) REFERENCES doctors(doctor_id) ON DELETE SET NULL
);

CREATE TABLE ref_doctors_list (
    ref_doctor_list_id INT AUTO_INCREMENT PRIMARY KEY,
    first VARCHAR(255),
    last VARCHAR(255),
    practice_nr VARCHAR(255) UNIQUE
);

CREATE TABLE ref_doctors (
    ref_doctor_id INT AUTO_INCREMENT PRIMARY KEY,
    ref_doctor_list_id INT,
    doctor_id INT,
    FOREIGN KEY (doctor_id) REFERENCES doctors(doctor_id) ON DELETE SET NULL,
    FOREIGN KEY (ref_doctor_list_id) REFERENCES ref_doctors_list(ref_doctor_list_id) ON DELETE SET NULL
);

CREATE TABLE service_centers_list (
    service_center_list_id INT AUTO_INCREMENT PRIMARY KEY,
    service_center_name VARCHAR(255),
    service_center_type ENUM('Hospital', 'Rooms') DEFAULT 'Hospital'
);

CREATE TABLE service_centers (
    service_center_id INT AUTO_INCREMENT PRIMARY KEY,
    service_center_list_id INT,
    doctor_id INT,
    FOREIGN KEY (doctor_id) REFERENCES doctors(doctor_id) ON DELETE SET NULL,
    FOREIGN KEY (service_center_list_id) REFERENCES service_centers_list(service_center_list_id) ON DELETE SET NULL
);

CREATE TABLE employers (
    employer_id INT AUTO_INCREMENT PRIMARY KEY,
    employer_name VARCHAR(255),
    employer_tel VARCHAR(255),
    emp_post_address VARCHAR(255),
    emp_str_address VARCHAR(255),
    emp_reg_nr VARCHAR(255) UNIQUE
);

CREATE TABLE medical_aids (
    medical_aid_id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) UNIQUE
);

CREATE TABLE medical_aid_plans (
    plan_id INT AUTO_INCREMENT PRIMARY KEY,
    medical_aid_id INT,
    plan_name VARCHAR(255),
    plan_code VARCHAR(255),
    FOREIGN KEY (medical_aid_id) REFERENCES medical_aids(medical_aid_id) ON DELETE SET NULL
);

CREATE TABLE profiles (
    profile_id INT AUTO_INCREMENT PRIMARY KEY,
    medical_aid_id INT, -- FK to medical_aids
    plan_id INT, 
    medical_aid_nr VARCHAR(255) UNIQUE, 
    authorization_nr VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    balance DECIMAL(10, 2) DEFAULT 0.00, -- Total balance for all accounts under this profile
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (medical_aid_id) REFERENCES medical_aids(medical_aid_id) ON DELETE SET NULL,
    FOREIGN KEY (plan_id) REFERENCES medical_aid_plans(plan_id) ON DELETE SET NULL
);

CREATE TABLE person_records (
    person_id INT AUTO_INCREMENT PRIMARY KEY,
    profile_id INT,
    first VARCHAR(255),
    last VARCHAR(255),
    title ENUM('Mr', 'Mrs', 'Miss', 'Ms', 'Dr') DEFAULT NULL,
    post_address VARCHAR(255),
    str_address VARCHAR(255),
    date_of_birth DATE,
    gender ENUM('M', 'F') DEFAULT NULL,
    dependent_nr INT,
    is_main_member boolean DEFAULT 0,
    id_type ENUM('Passport', 'SA ID', 'Other') DEFAULT NULL,
    id_nr VARCHAR(255) UNIQUE,
    cell_nr VARCHAR(20),
    tell_nr VARCHAR(20),
    work_nr VARCHAR(20),
    email VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (profile_id) REFERENCES profiles(profile_id) ON DELETE SET NULL
);

CREATE TABLE accounts (
    account_id INT AUTO_INCREMENT PRIMARY KEY,
    profile_id INT,
    doctor_id INT,
    main_member_id INT NULL,
    dependent_id INT NULL,
    balance DECIMAL(10, 2) DEFAULT 0.00, -- Balance for all invoices under this account
    FOREIGN KEY (doctor_id) REFERENCES doctors(doctor_id) ON DELETE SET NULL,
    FOREIGN KEY (main_member_id) REFERENCES person_records(person_id) ON DELETE SET NULL,
    FOREIGN KEY (dependent_id) REFERENCES person_records(person_id) ON DELETE SET NULL
);

CREATE TABLE invoices (
    invoice_id INT AUTO_INCREMENT PRIMARY KEY,
    account_id INT,
    profile_id INT,
    date_of_service DATE,
    status ENUM('Processing', 'Billed', 'Archived') DEFAULT 'Processing',
    patient_snapshot JSON,
    member_snapshot JSON,
    balance DECIMAL(10, 2) DEFAULT 0.00, -- Balance for this specific invoice (procedure)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (account_id) REFERENCES accounts(account_id) ON DELETE SET NULL,
    FOREIGN KEY (profile_id) REFERENCES profiles(profile_id) ON DELETE SET NULL
);


-- Inserting sample data for users
INSERT INTO users (email, password, first, last, address, tell_nr)
VALUES 
('user1@example.com', 'password_hash_1', 'John', 'Doe', '123 Main St', '123-456-7890'),
('user2@example.com', 'password_hash_2', 'Jane', 'Smith', '456 Elm St', '987-654-3210');

-- Inserting sample data for doctors
INSERT INTO doctors (email, password, first, last, registration_nr, practice_nr, tell_nr, doctor_type)
VALUES 
('doctor1@example.com', 'password_hash_1', 'Dr. Alice', 'Johnson', 'REG1234', 'PRACTICE001', '111-222-3333', 'Surgeon'),
('doctor2@example.com', 'password_hash_2', 'Dr. Bob', 'Williams', 'REG5678', 'PRACTICE002', '444-555-6666', 'Specialist');

-- Inserting sample data for medical aids
INSERT INTO medical_aids (name)
VALUES 
('Discovery'),
('Medihelp'),
('Private'),
('Momentum'),
('Bonitas');

-- Inserting sample data for medical aid plans
INSERT INTO medical_aid_plans (medical_aid_id, plan_name, plan_code)
VALUES 
(1, 'Classic Saver', 'CLASAVE2911'),
(2, 'MediBonus', 'MEDI1001'),
(3, 'Private', 'Private'),
(4, 'Basic', 'MOM001'),
(5, 'BonClassic', 'BONCLA0054');

-- Inserting sample data for profiles
INSERT INTO profiles (medical_aid_id, plan_id, medical_aid_nr, authorization_nr, is_active, balance)
VALUES 
(1, 1, '91672345', '701666', TRUE, 1200.00),
(2, 2, '42125516', '801666', TRUE, 1050.00),
(3, 3, '74577457', '901666', TRUE, 500.00),
(4, 4, 'FW515212', '1001666', TRUE, 5050.00);

-- Inserting sample data for person records
INSERT INTO person_records (profile_id, first, last, title, date_of_birth, gender, dependent_nr, is_main_member, id_nr, cell_nr, tell_nr, email)
VALUES 
(1, 'Thabo', 'Mokoena', 'Mr', '1990-05-15', 'M', 0, TRUE, '9005150000000', '082-111-2222', '011-333-4444', 'thabo@mokoena.co.za'),
(1, 'Naledi', 'Mokoena', 'Mrs', '1992-04-12', 'F', 1, FALSE, '9204120000000', '082-111-2223', '011-333-4445', 'naledi@mokoena.co.za'),
(1, 'Lerato', 'Mokoena', 'Miss', '2010-02-01', 'F', 2, FALSE, '1002010000000', '082-111-2224', '011-333-4446', 'lerato@mokoena.co.za'),

(2, 'Pieter', 'Van Der Merwe', 'Mr', '1990-08-05', 'F', 0, TRUE, '9008050000000', '082-111-2225', '011-333-4447', 'olivia@vdmerwe.co.za'),
(2, 'Annelize', 'Van Der Merwe', 'Mrs', '1980-11-22', 'M', 1, FALSE, '8011220000000', '082-111-2226', '011-333-4448', 'annelize@vdmerwe.co.za'),
(2, 'Jaco', 'Van Der Merwe', 'Mr', '2017-03-30', 'M', 2, FALSE, '1703300000000', '082-111-2227', '011-333-4449', 'jaco@vdmerwe.co.za'),
(2, 'Saki', 'Van Der Merwe', 'Mr', '2011-06-10', 'M', 3, FALSE, '1106100000000', '082-111-2227', '011-333-4449', 'saki@vdmerwe.co.za'),

(3, 'Jo-Anne', 'Smith', 'Mrs', '1972-07-20', 'F', 0, TRUE, '7207200000000', '082-222-3333', '011-444-5555', 'joanne@smith.co.za'),
(3, 'John', 'Smith', 'Mr', '1973-04-14', 'M', 1, FALSE, '7304140000000', '082-222-3334', '011-444-5556', 'john@smith.co.za'),
(3, 'Emily', 'Smith', 'Miss', '2001-06-22', 'F', 2, FALSE, '0106220000000', '082-222-3335', '011-444-5557', 'emily@smith.co.za'),

(4, 'Rajesh', 'Naidoo', 'Mr', '1982-09-17', 'M', 0, TRUE, '8209170000000', '082-222-3336', '011-444-5558', 'rajesh@naidoo.co.za'),
(4, 'Priya', 'Naidoo', 'Mrs', '1983-02-10', 'F', 1, FALSE, '8302100000000', '082-222-3337', '011-444-5559', 'priya@naidoo.co.za'),
(4, 'Kavita', 'Naidoo', 'Miss', '2000-02-10', 'F', 2, FALSE, '0002100000000', '082-222-3337', '011-444-5559', 'kavita@naidoo.co.za'),
(4, 'Sanjay', 'Naidoo', 'Mr', '1999-02-10', 'M', 3, FALSE, '9902100000000', '082-222-3337', '011-444-5559', 'sanjay@naidoo.co.za');

-- Inserting data into accounts
INSERT INTO accounts (profile_id, doctor_id, main_member_id, dependent_id, balance)
VALUES
-- Profile 1: Thabo (main member), Naledi, and Lerato (Total: 1200.00)
(1, 1, 1, 1, 500.00), -- Thabo's account
(1, 1, 1, 2, 400.00), -- Naledi's account
(1, 1, 1, 3, 100.00), -- Lerato's account
(1, 2, 1, 3, 200.00), -- Lerato's account second account with a diff doctor

-- Profile 2: Pieter (main member), Annelize, Jaco, and Saki (Total: 1050.00)
(2, 2, 4, 4, 450.00), -- Pieter's account
(2, 2, 4, 5, 300.00), -- Annelize's account
(2, 2, 4, 6, 200.00), -- Jaco's account
(2, 2, 4, 7, 100.00), -- Saki's account

-- Profile 3: Jo-Anne (main member), John, and Emily (Total: 500.00)
(3, 1, 8, 8, 250.00), -- Jo-Anne's account
(3, 1, 8, 9, 150.00), -- John's account
(3, 1, 8, 10, 100.00), -- Emily's account

-- Profile 4: Rajesh (main member), Priya, Kavita, and Sanjay (Total: 5050.00)
(4, 2, 11, 11, 2000.00), -- Rajesh's account
(4, 2, 11, 12, 1500.00), -- Priya's account
(4, 2, 11, 13, 1000.00), -- Kavita's account
(4, 2, 11, 14, 550.00); -- Sanjay's account

-- Inserting sample data for invoices
INSERT INTO invoices (account_id, profile_id, date_of_service, status, member_snapshot, patient_snapshot, balance)
VALUES
-- Profile 1: Thabo, Naledi, Lerato
(1, 1, '2024-12-01', 'Processing',
 '{"member": {"first": "Thabo", "last": "Mokoena", "title": "Mr", "dob": "1990-05-15", "id_nr": "9005150093000"}}',
 '{"patient": {"first": "Thabo", "last": "Mokoena", "title": "Mr", "dob": "1990-05-15", "id_nr": "9005150094000"}}',
 500.00),

(2, 1, '2024-12-02', 'Processing',
 '{"member": {"first": "Thabo", "last": "Mokoena", "title": "Mr", "dob": "1990-05-15", "id_nr": "9005150008900"}}',
 '{"patient": {"first": "Naledi", "last": "Mokoena", "title": "Mrs", "dob": "1992-04-12", "id_nr": "9204120990000"}}',
 400.00),

(3, 1, '2024-12-03', 'Processing',
 '{"member": {"first": "Thabo", "last": "Mokoena", "title": "Mr", "dob": "1990-05-15", "id_nr": "9005150008800"}}',
 '{"patient": {"first": "Lerato", "last": "Mokoena", "title": "Miss", "dob": "2010-02-01", "id_nr": "1002017700000"}}',
 100.00),

(4, 1, '2024-12-04', 'Processing',
 '{"member": {"first": "Thabo", "last": "Mokoena", "title": "Mr", "dob": "1990-05-15", "id_nr": "9005150006600"}}',
 '{"patient": {"first": "Lerato", "last": "Mokoena", "title": "Miss", "dob": "2010-02-01", "id_nr": "1002010000550"}}',
 200.00),

-- Profile 2: Pieter, Annelize, Jaco, Saki
(5, 2, '2024-12-01', 'Processing',
 '{"member": {"first": "Pieter", "last": "Van Der Merwe", "title": "Mr", "dob": "1990-08-05", "id_nr": "9008050044000"}}',
 '{"patient": {"first": "Pieter", "last": "Van Der Merwe", "title": "Mr", "dob": "1990-08-05", "id_nr": "9008050330000"}}',
 450.00),

(6, 2, '2024-12-02', 'Processing',
 '{"member": {"first": "Pieter", "last": "Van Der Merwe", "title": "Mr", "dob": "1990-08-05", "id_nr": "9008050022000"}}',
 '{"patient": {"first": "Annelize", "last": "Van Der Merwe", "title": "Mrs", "dob": "1980-11-22", "id_nr": "8011220011000"}}',
 300.00),

(7, 2, '2024-12-03', 'Processing',
 '{"member": {"first": "Pieter", "last": "Van Der Merwe", "title": "Mr", "dob": "1990-08-05", "id_nr": "9008059000000"}}',
 '{"patient": {"first": "Jaco", "last": "Van Der Merwe", "title": "Mr", "dob": "2017-03-30", "id_nr": "1703380000000"}}',
 200.00),

(8, 2, '2024-12-04', 'Processing',
 '{"member": {"first": "Pieter", "last": "Van Der Merwe", "title": "Mr", "dob": "1990-08-05", "id_nr": "9008050700000"}}',
 '{"patient": {"first": "Saki", "last": "Van Der Merwe", "title": "Mr", "dob": "2011-06-10", "id_nr": "1106160000000"}}',
 100.00),

-- Profile 3: Jo-Anne, John, Emily
(9, 3, '2024-12-01', 'Processing',
 '{"member": {"first": "Jo-Anne", "last": "Smith", "title": "Mrs", "dob": "1972-07-20", "id_nr": "7207205000000"}}',
 '{"patient": {"first": "Jo-Anne", "last": "Smith", "title": "Mrs", "dob": "1972-07-20", "id_nr": "7207240000000"}}',
 250.00),

(10, 3, '2024-12-02', 'Processing',
 '{"member": {"first": "Jo-Anne", "last": "Smith", "title": "Mrs", "dob": "1972-07-20", "id_nr": "7207203000000"}}',
 '{"patient": {"first": "John", "last": "Smith", "title": "Mr", "dob": "1973-04-14", "id_nr": "7304142000000"}}',
 150.00),

(11, 3, '2024-12-03', 'Processing',
 '{"member": {"first": "Jo-Anne", "last": "Smith", "title": "Mrs", "dob": "1972-07-20", "id_nr": "720721000000"}}',
 '{"patient": {"first": "Emily", "last": "Smith", "title": "Miss", "dob": "2001-06-22", "id_nr": "0106220000900"}}',
 100.00),

-- Profile 4: Rajesh, Priya, Kavita, Sanjay
(12, 4, '2024-12-01', 'Processing',
 '{"member": {"first": "Rajesh", "last": "Naidoo", "title": "Mr", "dob": "1982-09-17", "id_nr": "8209170000080"}}',
 '{"patient": {"first": "Rajesh", "last": "Naidoo", "title": "Mr", "dob": "1982-09-17", "id_nr": "8209170000700"}}',
 2000.00),

(13, 4, '2024-12-02', 'Processing',
 '{"member": {"first": "Rajesh", "last": "Naidoo", "title": "Mr", "dob": "1982-09-17", "id_nr": "8209170000060"}}',
 '{"patient": {"first": "Priya", "last": "Naidoo", "title": "Mrs", "dob": "1983-02-10", "id_nr": "8302100000050"}}',
 1500.00),

(14, 4, '2024-12-03', 'Processing',
 '{"member": {"first": "Rajesh", "last": "Naidoo", "title": "Mr", "dob": "1982-09-17", "id_nr": "8209170000400"}}',
 '{"patient": {"first": "Kavita", "last": "Naidoo", "title": "Miss", "dob": "2000-02-10", "id_nr": "0002103000000"}}',
 1000.00),

(15, 4, '2024-12-04', 'Processing',
 '{"member": {"first": "Rajesh", "last": "Naidoo", "title": "Mr", "dob": "1982-09-17", "id_nr": "8209170000200"}}',
 '{"patient": {"first": "Sanjay", "last": "Naidoo", "title": "Mr", "dob": "1999-02-10", "id_nr": "9902100000100"}}',
 550.00);


-- Inserting sample data for features
INSERT INTO features (feature_name)
VALUES 
('accounts'),
('invoices'),
('records'),
('profiles');

-- Inserting sample data for user features
INSERT INTO user_features (user_id, feature_id, is_active, permissions)
VALUES 
(1, 1, TRUE, 'Edit'),
(1, 2, TRUE, 'Edit'),
(1, 3, TRUE, 'Edit'),
(1, 4, TRUE, 'Edit'),
(2, 1, TRUE, 'Edit'),
(2, 2, TRUE, 'Edit'),
(2, 3, TRUE, 'Edit'),
(2, 4, TRUE, 'Edit'),
(3, 1, TRUE, 'Edit'),
(3, 2, TRUE, 'Edit'),
(3, 3, TRUE, 'Edit'),
(3, 4, TRUE, 'Edit'),
(4, 1, TRUE, 'Edit'),
(4, 2, TRUE, 'Edit'),
(4, 3, TRUE, 'Edit'),
(4, 4, TRUE, 'Edit'),
(5, 1, TRUE, 'Edit'),
(5, 2, TRUE, 'Edit'),
(5, 3, TRUE, 'Edit'),
(5, 4, TRUE, 'Edit');

-- Inserting sample data for service centers
INSERT INTO service_centers_list (service_center_name, service_center_type)
VALUES 
('City Hospital', 'Hospital'),
('Private Rooms', 'Rooms');

-- Inserting sample data for service centers associations
INSERT INTO service_centers (service_center_list_id, doctor_id)
VALUES 
(1, 1),
(1, 2),
(2, 3);

-- Inserting sample data for employers
INSERT INTO employers (employer_name, employer_tel, emp_post_address, emp_str_address, emp_reg_nr)
VALUES 
('TechCorp', '555-123-4567', '123 Tech Ave', 'Building 3', 'EMP123'),
('HealthOrg', '555-987-6543', '456 Health St', 'Suite 101', 'EMP456');

-- Inserting sample data for ref_doctors
INSERT INTO ref_doctors_list (first, last, practice_nr)
VALUES 
('Dr. Clara', 'Green', 'PRACTICE003'),
('Dr. David', 'Blue', 'PRACTICE004');

-- Inserting sample data for doctor referrals
INSERT INTO ref_doctors (ref_doctor_list_id, doctor_id)
VALUES 
(1, 1),
(1, 2),
(2, 3);
